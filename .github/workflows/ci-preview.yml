name: Build for CI

on:
  push:
    branches: [ "v10" ]
    paths-ignore:
      - "**.md"
  pull_request:
    branches: [ "v10" ]

env:
  DOTNET_VERSION: '10.0.100-preview.4.25258.110'
  PluginSolutionPath: 'src\Plugin.Maui.BottomSheet\Plugin.Maui.BottomSheet.sln'
  Configuration: 'Release'
  DOTNETFrameworkVersion: 'net10.0'

jobs:
  Build-Plugin_Maui_BottomSheet:

    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI Workload
        run: dotnet workload install maui --source https://api.nuget.org/v3/index.json

      - name: Build Plugin.Maui.BottomSheet
        run: dotnet build ${{ env.PluginSolutionPath }} -c ${{ env.Configuration }}
  
  Test-Plugin_Maui_BottomSheet-Android:
    
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI Workload
        run: dotnet workload install maui --source https://api.nuget.org/v3/index.json
        
      - name: Install XHarness
        run: dotnet tool install Microsoft.DotNet.XHarness.CLI
          --global
          --add-source https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-eng/nuget/v3/index.json
          --version "10.0.0-prerelease*"

      - name: Publish Android Plugin.Maui.BottomSheet.Tests.App
        run: dotnet publish tests\Plugin.Maui.BottomSheet.Tests.App\Plugin.Maui.BottomSheet.Tests.App.csproj -c ${{ env.Configuration }} -f ${{ env.DOTNETFrameworkVersion }}-android -r android-arm64 -p:TestingMode=XHarness

      - name: Test Android
        run: xharness android test
          --app tests/artifacts/publish/Plugin.Maui.BottomSheet.Tests.App/release_net10.0-android_android-arm64/com.companyname.plugin.maui.bottomsheet.tests.app-Signed.apk
          --package-name com.companyname.plugin.maui.bottomsheet.tests.app
          --instrumentation devicerunners.xharness.maui.XHarnessInstrumentation
          --output-directory artifacts
  
  Test-Plugin_Maui_BottomSheet-ios:

    runs-on: macos-15

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI Workload
        run: dotnet workload install maui --source https://api.nuget.org/v3/index.json
        
      - name: Install XHarness
        run: dotnet tool install Microsoft.DotNet.XHarness.CLI
          --global
          --add-source https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-eng/nuget/v3/index.json
          --version "10.0.0-prerelease*"
        
      - name: Build iOS Plugin.Maui.BottomSheet.Tests.App
        run: dotnet build tests/Plugin.Maui.BottomSheet.Tests.App\Plugin.Maui.BottomSheet.Tests.App.csproj -c Debug -f ${{ env.DOTNETFrameworkVersion }}-ios -r iossimulator-arm64 -p:TestingMode=XHarness

      - name: Test iOS
        run: xharness apple test
          --target ios-simulator-64
          --app tests/artifacts/bin/Plugin.Maui.BottomSheet.Tests.App/debug_net10.0-ios_iossimulator-arm64/Plugin.Maui.BottomSheet.Tests.App.app
          --output-directory artifacts

  Test-Plugin_Maui_BottomSheet-maccatalyst:

    runs-on: macos-15

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install .NET MAUI Workload
        run: dotnet workload install maui --source https://api.nuget.org/v3/index.json
        
      - name: Install XHarness
        run: dotnet tool install Microsoft.DotNet.XHarness.CLI
          --global
          --add-source https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-eng/nuget/v3/index.json 
          --version "10.0.0-prerelease*"
        
      - name: Build MacCatalyst Plugin.Maui.BottomSheet.Tests.App
        run: dotnet build tests/Plugin.Maui.BottomSheet.Tests.App\Plugin.Maui.BottomSheet.Tests.App.csproj -c Debug -f ${{ env.DOTNETFrameworkVersion }}-maccatalyst -r maccatalyst-arm64 -p:TestingMode=XHarness

      - name: Test MacCatalyst
        run: xharness apple test
          --target ios-simulator-64
          --app tests/artifacts/bin/Plugin.Maui.BottomSheet.Tests.App/debug_net10.0-maccatalyst_maccatalyst-arm64/Plugin.Maui.BottomSheet.Tests.App.app
          --output-directory artifacts